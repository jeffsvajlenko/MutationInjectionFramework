int socket_read(Socket_T S, void *b, int size)
{

    int n= 0;
    void *p= b;
    int timeout= 0;

    ASSERT(S);

    timeout= S->timeout;

    while(size > 0)
    {
        if(S->ssl)
        {
            n= recv_ssl_socket(S->ssl, p, size, timeout);
        }
        else
        {
            n= sock_read(S->socket, p, size, timeout);
        }
        if(n <= 0) break;
        p+= n;
        size-= n;
        /* We managed to read some bytes and we only keep on reading
         * available data, otherwise we return with what we have read
         */
        timeout= 0;
    }

    if(n < 0 && p==b)
    {
        return -1;
    }

    return (int) p - (int) b;

}